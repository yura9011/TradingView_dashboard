{% extends "base.html" %}

{% block title %}{{ signal.symbol }} Analysis ‚Ä¢ TradingAI{% endblock %}

{% block content %}
<div class="detail-header">
    <a href="/" class="back-link">‚Üê Back to Dashboard</a>
    <h1>
        {{ signal.symbol }}
        {% if signal.signal_type == 'candidate' %}
        <span class="badge badge-success">Candidate</span>
        {% elif signal.signal_type == 'not_candidate' %}
        <span class="badge badge-danger">Not Viable</span>
        {% else %}
        <span class="badge badge-warning">Pending</span>
        {% endif %}
    </h1>
    <p class="subtitle" style="margin-top: 8px;">Analyzed: {{ signal.timestamp }}</p>
</div>

<div class="detail-grid">
    <!-- Chart -->
    <div class="card" style="grid-column: 1 / -1;">
        <h2>üìà Chart</h2>
        {% if signal.chart_image_path %}
        {% set path_str = signal.chart_image_path|string %}
        {% set chart_filename = path_str.split('\\')[-1].split('/')[-1] %}
        {% set reasoning = signal.detailed_reasoning|fromjson if signal.detailed_reasoning else {} %}
        {% set annotated_path = reasoning.get('pattern', {}).get('annotated_chart_path', '') if reasoning else '' %}
        {% set annotated_filename = annotated_path.split('\\')[-1].split('/')[-1] if annotated_path else '' %}
        <div class="chart-container">
            {% if annotated_filename %}
            <!-- Show YOLO annotated chart if available (try charts folder first, then reports) -->
            <img src="/charts/{{ annotated_filename }}" alt="Annotated Chart for {{ signal.symbol }}" class="chart-image"
                onerror="this.onerror=null; this.src='/reports/{{ chart_filename }}'">
            {% else %}
            <img src="/reports/{{ chart_filename }}" alt="Chart for {{ signal.symbol }}" class="chart-image"
                onerror="this.onerror=null; this.src='/charts/{{ chart_filename.replace('_chart.png', '.png') }}'">
            {% endif %}
        </div>
        {% else %}
        <p style="color: var(--text-muted); text-align: center; padding: 40px;">No chart available</p>
        {% endif %}
    </div>

    <!-- Patterns Detected -->
    <div class="card" style="grid-column: 1 / -1;">
        <h2>üìä Patrones Detectados</h2>
        
        {% set reasoning = signal.detailed_reasoning|fromjson if signal.detailed_reasoning else {} %}
        {% set reference_matches = reasoning.get('pattern', {}).get('reference_matches', []) if reasoning else [] %}
        {% set pattern_from_reasoning = reasoning.get('pattern', {}).get('name', 'none') if reasoning else 'none' %}
        {% set confidence_from_reasoning = reasoning.get('pattern', {}).get('confidence', 0) if reasoning else 0 %}
        
        {# Use pattern from detailed_reasoning if pattern_detected is none #}
        {% set actual_pattern = signal.pattern_detected if signal.pattern_detected and signal.pattern_detected != 'none' else pattern_from_reasoning %}
        {% set actual_confidence = signal.pattern_confidence if signal.pattern_confidence else confidence_from_reasoning %}
        
        {% if actual_pattern and actual_pattern != 'none' %}
        <div class="patterns-container">
            <!-- Main Pattern -->
            <div class="pattern-card">
                <div class="pattern-header">
                    <h3>{{ actual_pattern|replace('_', ' ')|title }}</h3>
                    <span class="confidence-badge">{{ (actual_confidence * 100)|int }}% confianza</span>
                </div>
                
                {% if reference_matches %}
                {% for match in reference_matches %}
                <div class="reference-section">
                    <p class="reference-label">
                        Referencia ({{ (match.best_match.similarity * 100)|int }}% similitud):
                    </p>
                    <div class="reference-image-container">
                        {% set ref_path = match.best_match.reference_path %}
                        {% set ref_filename = ref_path.split('\\')[-1].split('/')[-1] %}
                        <img src="/pattern_references/{{ ref_filename }}" 
                             alt="{{ match.best_match.display_name }}" 
                             class="reference-image"
                             onerror="this.style.display='none'">
                    </div>
                    <p class="reference-name">{{ match.best_match.display_name }}</p>
                </div>
                {% endfor %}
                {% else %}
                <p class="no-reference">Sin imagen de referencia disponible</p>
                {% endif %}
            </div>
        </div>
        {% else %}
        <p style="color: var(--text-muted); text-align: center; padding: 40px;">
            No se detectaron patrones en este chart
        </p>
        {% endif %}
    </div>

    <!-- Analysis Summary (Simplified) -->
    <div class="card">
        <h2>üß† Resumen</h2>
        <div class="analysis-content">
            <p>{{ signal.analysis_summary or 'No analysis summary available.' }}</p>
        </div>
    </div>

    <!-- Debug Info (Collapsed) -->
    <div class="card debug-card">
        <h2>üîß Datos T√©cnicos</h2>
        <details>
            <summary>Mostrar detalles</summary>
            <div class="technical-details">
                <p><strong>Tendencia:</strong> 
                    {% if signal.trend == 'up' %}‚Üë Alcista{% elif signal.trend == 'down' %}‚Üì Bajista{% else %}‚Üí Lateral{% endif %}
                    ({{ signal.trend_strength|title if signal.trend_strength else 'N/A' }})
                </p>
                {% if signal.support_level %}
                <p><strong>Soporte:</strong> ${{ '%.2f'|format(signal.support_level) }}</p>
                {% endif %}
                {% if signal.resistance_level %}
                <p><strong>Resistencia:</strong> ${{ '%.2f'|format(signal.resistance_level) }}</p>
                {% endif %}
            </div>
            <details style="margin-top: 10px;">
                <summary>JSON completo</summary>
                <pre class="debug-json">{{ signal|tojson(indent=2) }}</pre>
            </details>
        </details>
    </div>
</div>

<style>
.patterns-container {
    display: flex;
    flex-direction: column;
    gap: 20px;
}

.pattern-card {
    background: var(--bg-secondary);
    border-radius: 8px;
    padding: 20px;
    border: 1px solid var(--border-color);
}

.pattern-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
}

.pattern-header h3 {
    margin: 0;
    color: var(--text-primary);
    font-size: 1.2rem;
}

.confidence-badge {
    background: var(--accent-primary);
    color: white;
    padding: 4px 12px;
    border-radius: 20px;
    font-size: 0.85rem;
    font-weight: 500;
}

.reference-section {
    margin-top: 15px;
    padding-top: 15px;
    border-top: 1px solid var(--border-color);
}

.reference-label {
    color: var(--text-muted);
    font-size: 0.9rem;
    margin-bottom: 10px;
}

.reference-image-container {
    background: var(--bg-tertiary);
    border-radius: 8px;
    padding: 10px;
    text-align: center;
}

.reference-image {
    max-width: 100%;
    max-height: 300px;
    border-radius: 4px;
}

.reference-name {
    text-align: center;
    color: var(--text-secondary);
    font-size: 0.9rem;
    margin-top: 8px;
    font-style: italic;
}

.no-reference {
    color: var(--text-muted);
    font-style: italic;
    text-align: center;
    padding: 20px;
}

.technical-details {
    padding: 15px;
    background: var(--bg-tertiary);
    border-radius: 8px;
    margin-top: 10px;
}

.technical-details p {
    margin: 5px 0;
}
</style>
{% endblock %}
