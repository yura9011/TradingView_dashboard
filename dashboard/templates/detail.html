{% extends "base.html" %}

{% block title %}{{ signal.symbol }} Analysis ‚Ä¢ TradingAI{% endblock %}

{% block content %}
<div class="detail-header">
    <a href="/" class="back-link">‚Üê Back to Dashboard</a>
    <h1>
        {{ signal.symbol }}
        {% if signal.signal_type == 'candidate' %}
        <span class="badge badge-success">Candidate</span>
        {% elif signal.signal_type == 'not_candidate' %}
        <span class="badge badge-danger">Not Viable</span>
        {% else %}
        <span class="badge badge-warning">Pending</span>
        {% endif %}
    </h1>
    <p class="subtitle" style="margin-top: 8px;">Analyzed: {{ signal.timestamp }}</p>
</div>

<div class="detail-grid">
    <!-- AI Analysis Summary -->
    <div class="card">
        <h2>üß† AI Analysis</h2>
        <div class="analysis-content">
            <p>{{ signal.analysis_summary or 'No analysis summary available.' }}</p>
        </div>

        <div class="metrics-grid">
            <div class="metric">
                <label>Pattern</label>
                <span>{{ signal.pattern_detected|replace('_', ' ')|title if signal.pattern_detected != 'none' else 'None' }}</span>
            </div>
            <div class="metric">
                <label>Confidence</label>
                <span class="confidence-value">{{ (signal.pattern_confidence * 100)|int }}%</span>
            </div>
            <div class="metric">
                <label>Trend</label>
                <span class="{% if signal.trend == 'up' %}trend-up{% elif signal.trend == 'down' %}trend-down{% else %}trend-sideways{% endif %}">
                    {% if signal.trend == 'up' %}‚Üë Bullish{% elif signal.trend == 'down' %}‚Üì Bearish{% else %}‚Üí Sideways{% endif %}
                </span>
            </div>
            <div class="metric">
                <label>Strength</label>
                <span>{{ signal.trend_strength|title if signal.trend_strength else 'N/A' }}</span>
            </div>
            <div class="metric">
                <label>Wyckoff</label>
                <span class="phase-{{ signal.market_phase or 'unclear' }}">{{ signal.market_phase|title if signal.market_phase else 'N/A' }}</span>
            </div>
            <div class="metric">
                <label>Elliott</label>
                <span>{{ signal.elliott_wave if signal.elliott_wave else 'N/A' }}</span>
            </div>
        </div>
    </div>

    <!-- Technical Levels -->
    <div class="card">
        <h2>üìä Technical Levels</h2>
        <div class="levels-grid">
            <div class="level">
                <label>Support</label>
                <span style="color: var(--accent-success);">${{ '%.2f'|format(signal.support_level) if signal.support_level else '‚Äî' }}</span>
            </div>
            <div class="level">
                <label>Resistance</label>
                <span style="color: var(--accent-danger);">${{ '%.2f'|format(signal.resistance_level) if signal.resistance_level else '‚Äî' }}</span>
            </div>
            <div class="level">
                <label>Fibonacci</label>
                <span style="color: var(--accent-info);">{{ signal.fibonacci_level or '‚Äî' }}</span>
            </div>
        </div>
    </div>

    <!-- Chart -->
    <div class="card" style="grid-column: 1 / -1;">
        <h2>üìà Annotated Chart</h2>
        {% if signal.chart_image_path %}
        {% set path_str = signal.chart_image_path|string %}
        {% set chart_filename = path_str.split('\\')[-1].split('/')[-1] %}
        <div class="chart-container">
            <img src="/reports/{{ chart_filename }}" alt="Chart for {{ signal.symbol }}" class="chart-image"
                onerror="this.onerror=null; this.src='/charts/{{ chart_filename.replace('_chart.png', '.png') }}'">
        </div>
        {% else %}
        <p style="color: var(--text-muted); text-align: center; padding: 40px;">No chart available</p>
        {% endif %}
    </div>

    <!-- Detailed Reasoning -->
    {% if signal.detailed_reasoning %}
    {% set reasoning = signal.detailed_reasoning|fromjson if signal.detailed_reasoning else {} %}
    <div class="card reasoning-card">
        <h2>üí° Detailed Reasoning</h2>

        {% if reasoning.pattern and (reasoning.pattern.reasoning or reasoning.pattern.components) %}
        <div class="reasoning-section">
            <h3>Pattern Analysis</h3>
            <p><strong>{{ reasoning.pattern.name|title if reasoning.pattern.name and reasoning.pattern.name != 'none' else 'None detected' }}</strong>
               ({{ (reasoning.pattern.confidence * 100)|int }}% confidence)</p>
            {% if reasoning.pattern.components %}
            <p><strong>Components:</strong> {{ reasoning.pattern.components }}</p>
            {% endif %}
            {% if reasoning.pattern.target %}
            <p><strong>Target:</strong> {{ reasoning.pattern.target }}</p>
            {% endif %}
            {% if reasoning.pattern.invalidation %}
            <p><strong>Invalidation:</strong> {{ reasoning.pattern.invalidation }}</p>
            {% endif %}
            {% if reasoning.pattern.reasoning %}
            <p class="reasoning-text">{{ reasoning.pattern.reasoning }}</p>
            {% endif %}
        </div>
        {% endif %}

        {% if reasoning.wyckoff and reasoning.wyckoff.phase and reasoning.wyckoff.phase != 'unclear' %}
        <div class="reasoning-section" style="border-left-color: var(--accent-warning);">
            <h3>Wyckoff Analysis</h3>
            <p><strong>Phase:</strong> <span class="phase-{{ reasoning.wyckoff.phase }}">{{ reasoning.wyckoff.phase|title }}</span></p>
            {% if reasoning.wyckoff.event %}
            <p><strong>Event:</strong> {{ reasoning.wyckoff.event }}</p>
            {% endif %}
        </div>
        {% endif %}

        {% if reasoning.elliott and (reasoning.elliott.wave or reasoning.elliott.wave_count) %}
        <div class="reasoning-section" style="border-left-color: var(--accent-success);">
            <h3>Elliott Wave</h3>
            {% if reasoning.elliott.wave %}
            <p><strong>Current Wave:</strong> {{ reasoning.elliott.wave }}</p>
            {% endif %}
            {% if reasoning.elliott.wave_count %}
            <p><strong>Wave Count:</strong> {{ reasoning.elliott.wave_count }}</p>
            {% endif %}
        </div>
        {% endif %}

        {% if reasoning.levels and (reasoning.levels.support_reason or reasoning.levels.resistance_reason) %}
        <div class="reasoning-section" style="border-left-color: var(--accent-danger);">
            <h3>Levels Justification</h3>
            {% if reasoning.levels.support and reasoning.levels.support_reason %}
            <p><strong>Support ${{ '%.2f'|format(reasoning.levels.support) }}:</strong> {{ reasoning.levels.support_reason }}</p>
            {% endif %}
            {% if reasoning.levels.resistance and reasoning.levels.resistance_reason %}
            <p><strong>Resistance ${{ '%.2f'|format(reasoning.levels.resistance) }}:</strong> {{ reasoning.levels.resistance_reason }}</p>
            {% endif %}
            {% if reasoning.levels.key_level and reasoning.levels.key_level_reason %}
            <p><strong>Key Level ${{ '%.2f'|format(reasoning.levels.key_level) }}:</strong> {{ reasoning.levels.key_level_reason }}</p>
            {% endif %}
            {% if reasoning.levels.fibonacci_confluence %}
            <p><strong>Fibonacci:</strong> {{ reasoning.levels.fibonacci_confluence }}</p>
            {% endif %}
        </div>
        {% endif %}
    </div>
    {% endif %}

    <!-- Debug Info -->
    <div class="card debug-card">
        <h2>üîß Raw Data</h2>
        <details>
            <summary>Show JSON</summary>
            <pre class="debug-json">{{ signal|tojson(indent=2) }}</pre>
        </details>
    </div>
</div>

<!-- History -->
{% if history and history|length > 1 %}
<div class="card history-card" style="margin-top: 20px;">
    <h2>üìú Analysis History</h2>
    <table class="history-table">
        <thead>
            <tr>
                <th>Date</th>
                <th>Status</th>
                <th>Confidence</th>
                <th>Pattern</th>
            </tr>
        </thead>
        <tbody>
            {% for h in history %}
            <tr {% if h.id == signal.id %}class="current"{% endif %}>
                <td>{{ h.timestamp[:16] }}</td>
                <td>
                    {% if h.signal_type == 'candidate' %}
                    <span class="badge badge-success" style="font-size: 0.7rem;">Candidate</span>
                    {% elif h.signal_type == 'not_candidate' %}
                    <span class="badge badge-danger" style="font-size: 0.7rem;">Not Viable</span>
                    {% else %}
                    <span class="badge badge-warning" style="font-size: 0.7rem;">Pending</span>
                    {% endif %}
                </td>
                <td>{{ (h.pattern_confidence * 100)|int }}%</td>
                <td>{{ h.pattern_detected|replace('_', ' ')|title }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% endif %}
{% endblock %}
